<?php

namespace App\Livewire;

use Livewire\Component;
use Livewire\WithPagination;
use Livewire\WithFileUploads;
use App\Models\Medicine;
use App\Models\Category;
use Illuminate\Support\Facades\Storage;
use App\Traits\FillsComponentFromModel;

use App\Exports\MedicinesExport;
use Maatwebsite\Excel\Facades\Excel;
// use Illuminate\Support\Facades\Response;
// use App\Exports\MedicinesTemplateExport;

// use PhpOffice\PhpSpreadsheet\Cell\Coordinate;
// use PhpOffice\PhpSpreadsheet\Style\NumberFormat;
// use PhpOffice\PhpSpreadsheet\IOFactory;
// use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use App\Traits\HasExcelExportTemplate;

class Medicines extends Component
{
    use WithPagination, WithFileUploads;
    use FillsComponentFromModel;
    use HasExcelExportTemplate;

    public $search = '',
        $perPage = 10,
        $sortField = 'id',
        $sortDirection = 'desc';
    public $showForm = false,
        $medicineId,
        $activeTab = 'general',
        $image,
        $link_hinh_anh;
    public $selectedProducts = [],
        $selectAll = false,
        $selectedCategory = null;
    public $ten_biet_duoc, $ten_hoat_chat, $dang_bao_che, $duong_dung;
    public $nong_do_ham_luong, $don_vi_tinh, $quy_cach_dong_goi, $giay_phep_luu_hanh;
    public $han_dung, $co_so_san_xuat, $nuoc_san_xuat, $gia_ke_khai, $don_gia, $gia_von;
    public $trang_thai_trung_thau, $nha_phan_phoi, $nhom_thuoc, $stt_tt20_2022, $phan_nhom_tt15;
    public $link_hssp, $han_dung_visa, $han_dung_gmp;

    public $categories = [],
        $selectedCategories = [],
        $bulkCategory = null;

    protected $listeners = [
        'categoriesApplied' => 'onCategoriesApplied',
        'categoriesUpdated' => 'onCategoriesUpdated',
    ];

    public function onCategoriesApplied($selected)
    {
        $this->selectedCategories = $selected;

        if (empty($this->selectedProducts)) {
            session()->flash('message', 'Vui l√≤ng ch·ªçn thu·ªëc c·∫ßn √°p d·ª•ng danh m·ª•c.');
            return;
        }

        if (empty($selected)) {
            session()->flash('message', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt danh m·ª•c.');
            return;
        }

        // ‚úÖ C·∫≠p nh·∫≠t danh m·ª•c cho t·∫•t c·∫£ thu·ªëc ƒë√£ ch·ªçn
        foreach ($this->selectedProducts as $id) {
            $medicine = Medicine::find($id);
            if ($medicine) {
                // Th√™m danh m·ª•c m√† kh√¥ng xo√° danh m·ª•c c≈©
                $medicine->categories()->syncWithoutDetaching($selected);
            }
        }

        // Tu·ª≥ ch·ªçn: reset selections
        $this->selectedProducts = [];
        $this->selectedCategories = [];

        session()->flash('success', 'ƒê√£ √°p d·ª•ng danh m·ª•c cho c√°c thu·ªëc ƒë√£ ch·ªçn th√†nh c√¥ng!');
    }

    public function removeCategory($productId, $categoryId, $catName = '')
    {
        //dd($productId, $categoryId);
        $medicine = Medicine::find($productId);
        if (!$medicine) {
            return;
        }
        $name = $medicine['ten_biet_duoc'];

        $medicine->categories()->detach($categoryId);

        session()->flash('message', "ƒê√£ x√≥a danh m·ª•c $catName ra kh·ªèi s·∫£n ph·∫©m: $name");
    }

    public function onCategoriesUpdated($selected)
    {
        $this->selectedCategories = $selected;
    }

    protected $rules = [
        'ten_biet_duoc' => 'required|string|max:255',
        'ten_hoat_chat' => 'nullable|string|max:255',
        'gia_ke_khai' => 'nullable|numeric',
        'don_gia' => 'nullable|numeric',
    ];

    protected $messages = [
        'ten_biet_duoc.required' => 'Vui l√≤ng nh·∫≠p t√™n bi·ªát d∆∞·ª£c',
    ];

    public function mount()
    {
        $root = Category::where('slug', 'nhom-thuoc')->first();
        if ($root) {
            $this->categories = Category::with('children')->where('id', $root->id)->orWhere('parent_id', $root->id)->get();
        } else {
            $this->categories = collect();
        }
        //dd($this->categories);
        $this->perPage = session('medicines_per_page', $this->perPage);
    }

    public function render()
    {
        $query = Medicine::with('categories')->when($this->search, fn($q) => $q->where(fn($sub) => $sub->where('ten_biet_duoc', 'like', "%$this->search%")->orWhere('ten_hoat_chat', 'like', "%$this->search%")))->when($this->selectedCategory, fn($q) => $q->whereHas('categories', fn($sub) => $sub->where('categories.id', $this->selectedCategory)))->orderBy($this->sortField, $this->sortDirection);

        $medicines = $this->perPage === 'all' ? $query->get() : $query->paginate($this->perPage);

        return view('livewire.medicines', ['medicines' => $medicines]);
    }

    public function create()
    {
        $this->resetForm();
        $this->showForm = true;
        $this->dispatch('setHeader', 'Th√™m thu·ªëc');
    }

    public function edit($id)
    {
        $m = Medicine::with('categories')->findOrFail($id);
        $this->fillFromModel($m, ['categories']);
        $this->selectedCategories = $m->categories->pluck('id')->toArray();
        //dd($this->selectedCategories);
        $this->medicineId = $id;
        $this->showForm = true;
        $this->dispatch('setHeader', 'Ch·ªânh s·ª≠a thu·ªëc');
    }

    public function save()
    {
        $this->validate();

        // L∆∞u ·∫£nh n·∫øu c√≥
        if ($this->image) {
            $this->link_hinh_anh = $this->image->store('medicines', 'public');
        }

        // L∆∞u ho·∫∑c c·∫≠p nh·∫≠t thu·ªëc
        $medicine = Medicine::updateOrCreate(['id' => $this->medicineId], $this->only(['stt_tt20_2022', 'phan_nhom_tt15', 'ten_hoat_chat', 'nong_do_ham_luong', 'ten_biet_duoc', 'dang_bao_che', 'duong_dung', 'don_vi_tinh', 'quy_cach_dong_goi', 'giay_phep_luu_hanh', 'han_dung', 'co_so_san_xuat', 'nuoc_san_xuat', 'gia_ke_khai', 'don_gia', 'gia_von', 'trang_thai_trung_thau', 'nha_phan_phoi', 'nhom_thuoc', 'link_hinh_anh', 'link_hssp', 'han_dung_visa', 'han_dung_gmp']));

        // üëâ C·∫≠p nh·∫≠t li√™n k·∫øt danh m·ª•c
        if (!empty($this->selectedCategories)) {
            $medicine->categories()->sync($this->selectedCategories);
        } else {
            // N·∫øu kh√¥ng ch·ªçn danh m·ª•c n√†o th√¨ b·ªè h·∫øt li√™n k·∫øt c≈©
            $medicine->categories()->detach();
        }

        // Th√¥ng b√°o th√†nh c√¥ng
        session()->flash('success', 'ƒê√£ l∆∞u th√¥ng tin thu·ªëc th√†nh c√¥ng!');

        // Reset form
        $this->resetForm();
        $this->showForm = false;

        // ƒê·ªïi header
        $this->dispatch('setHeader', 'Danh s√°ch thu·ªëc');
    }

    public function cancel()
    {
        $this->resetForm();
        $this->showForm = false;
        $this->dispatch('setHeader', 'Danh s√°ch thu·ªëc');
    }

    public function delete($id)
    {
        $m = Medicine::findOrFail($id);
        if ($m->link_hinh_anh) {
            Storage::disk('public')->delete($m->link_hinh_anh);
        }
        $m->delete();
        session()->flash('success', "ƒê√£ xo√° {$m->ten_biet_duoc} th√†nh c√¥ng.");
    }

    private function resetForm()
    {
        $this->reset(['medicineId', 'ten_biet_duoc', 'ten_hoat_chat', 'dang_bao_che', 'duong_dung', 'nong_do_ham_luong', 'don_vi_tinh', 'quy_cach_dong_goi', 'giay_phep_luu_hanh', 'han_dung', 'co_so_san_xuat', 'nuoc_san_xuat', 'gia_ke_khai', 'don_gia', 'gia_von', 'trang_thai_trung_thau', 'nha_phan_phoi', 'nhom_thuoc', 'link_hinh_anh', 'selectedCategories', 'image', 'link_hssp', 'han_dung_visa', 'han_dung_gmp']);
    }

    public function removeImage()
    {
        if ($this->link_hinh_anh) {
            Storage::disk('public')->delete($this->link_hinh_anh);
        }
        $this->link_hinh_anh = null;
        $this->image = null; // reset file upload Livewire
        $this->dispatch('image-removed', ['tab' => $this->activeTab]);
    }

    public function clearSearch()
    {
        $this->reset('search');
        $this->resetPage();
    }

    public function updatedSelectAll($val)
    {
        $query = Medicine::when($this->search, fn($q) => $q->where('ten_biet_duoc', 'like', "%$this->search%")->orWhere('ten_hoat_chat', 'like', "%$this->search%"))->orderBy($this->sortField, $this->sortDirection);

        if ($val) {
            // L·∫•y ID c·ªßa trang hi·ªán t·∫°i
            $medicines = $this->perPage === 'all' ? $query->get() : $query->paginate($this->perPage);
            $this->selectedProducts = $medicines->pluck('id')->toArray();
        } else {
            $this->selectedProducts = [];
        }
    }

    public function updatedSelectedProducts()
    {
        $query = Medicine::when($this->search, fn($q) => $q->where('ten_biet_duoc', 'like', "%$this->search%")->orWhere('ten_hoat_chat', 'like', "%$this->search%"));

        $medicinesOnPage = $this->perPage === 'all' ? $query->get() : $query->paginate($this->perPage);

        $this->selectAll = count($this->selectedProducts) === $medicinesOnPage->count();
    }

    public function deleteSelected()
    {
        if ($this->selectedProducts) {
            $items = Medicine::whereIn('id', $this->selectedProducts)->get();
            foreach ($items as $m) {
                if ($m->link_hinh_anh) {
                    Storage::disk('public')->delete($m->link_hinh_anh);
                }
            }
            Medicine::whereIn('id', $this->selectedProducts)->delete();
            $this->selectedProducts = [];
            $this->selectAll = false;
            session()->flash('message', 'ƒê√£ x√≥a c√°c thu·ªëc ƒë√£ ch·ªçn.');
        }
    }

    public function duplicate($id)
    {
        $m = Medicine::with('categories')->findOrFail($id);
        $new = $m->replicate();
        $new->ten_biet_duoc .= ' (B·∫£n sao)';
        $new->save();
        $new->categories()->sync($m->categories->pluck('id')->toArray());
        session()->flash('success', "ƒê√£ nh√¢n b·∫£n thu·ªëc '{$m->ten_biet_duoc}' th√†nh c√¥ng.");
    }

    public function applySelectedCategory()
    {
        if (empty($this->selectedProducts)) {
            session()->flash('message', 'Vui l√≤ng ch·ªçn thu·ªëc.');
            return;
        }

        if (empty($this->selectedCategories)) {
            session()->flash('message', 'Vui l√≤ng ch·ªçn danh m·ª•c.');
            return;
        }

        foreach ($this->selectedProducts as $id) {
            $medicine = Medicine::find($id);
            if ($medicine) {
                // Th√™m danh m·ª•c m√† kh√¥ng b·ªè c√°c danh m·ª•c c≈©
                $medicine->categories()->syncWithoutDetaching($this->selectedCategories);
            }
        }

        // Reset selected products / categories n·∫øu mu·ªën
        $this->selectedProducts = [];
        $this->selectedCategories = [];

        session()->flash('success', 'C·∫≠p nh·∫≠t danh m·ª•c th√†nh c√¥ng!');
    }

    public function exportJson()
    {
        $categories = Category::select('id', 'name', 'slug', 'type', 'is_active')->get();
        $query = Medicine::with('categories');
        if ($this->selectedProducts) {
            $query->whereIn('id', $this->selectedProducts);
        }
        $medicines = $query->get();
        $data = [
            'categories' => $categories->map(fn($c) => ['id' => $c->id, 'name' => $c->name, 'slug' => $c->slug, 'type' => $c->type, 'is_active' => (bool) ($c->is_active ?? false)])->toArray(),
            'medicines' => $medicines->map(fn($m) => ['id' => $m->id, 'ten_biet_duoc' => $m->ten_biet_duoc, 'ten_hoat_chat' => $m->ten_hoat_chat, 'don_gia' => $m->don_gia, 'gia_ke_khai' => $m->gia_ke_khai, 'link_hinh_anh' => $m->link_hinh_anh ?? 'images/default.jpg', 'categories' => $m->categories->pluck('id')->toArray()])->toArray(),
        ];
        $filename = 'medicines_export_' . now()->format('Ymd_His') . '.json';
        return response()->streamDownload(fn() => print json_encode($data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT), $filename, ['Content-Type' => 'application/json']);
    }
    public function updatedActiveTab($tab)
    {
        $this->activeTab = $tab;
    }
    public function updatingSearch()
    {
        $this->resetPage();
    }
    public function updatingPerPage($val)
    {
        session(['medicines_per_page' => $val]);
        $this->resetPage();
    }
    public function sortBy($field)
    {
        if ($this->sortField === $field) {
            $this->sortDirection = $this->sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            $this->sortField = $field;
            $this->sortDirection = 'asc';
        }
    }
    public function exportSelectedToExcel()
    {
        if (empty($this->selectedProducts)) {
            $this->dispatch('notify', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ xu·∫•t Excel.');
            return;
        }

        $fileName = 'Danh_sach_thuoc_' . now()->format('Ymd_His') . '.xlsx';
        return Excel::download(new MedicinesExport($this->selectedProducts), $fileName);
    }
  
    public function exportWithTemplate(array $options = [])
    {
        if (empty($this->selectedProducts)) {
            $this->dispatch('notify', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ xu·∫•t Excel.');
            return;
        }
    
        // ----- 1Ô∏è‚É£ M·∫∑c ƒë·ªãnh c√°c tham s·ªë -----
        $defaultColumns = [
            ['field' => 'stt_tt20_2022', 'title' => 'STT TT20/2022'],
            ['field' => 'phan_nhom_tt15', 'title' => 'Ph√¢n nh√≥m TT15'],
            ['field' => 'ten_hoat_chat', 'title' => 'T√™n ho·∫°t ch·∫•t', 'align' => 'left'],
            ['field' => 'nong_do_ham_luong', 'title' => 'N·ªìng ƒë·ªô / H√†m l∆∞·ª£ng'],
            ['field' => 'ten_biet_duoc', 'title' => 'T√™n bi·ªát d∆∞·ª£c', 'align' => 'left'],
            ['field' => 'dang_bao_che', 'title' => 'D·∫°ng b√†o ch·∫ø'],
            ['field' => 'don_vi_tinh', 'title' => 'ƒê∆°n v·ªã t√≠nh'],
            ['field' => 'quy_cach_dong_goi', 'title' => 'Quy c√°ch ƒë√≥ng g√≥i'],
            ['field' => 'giay_phep_luu_hanh', 'title' => 'S·ªë GPLH'],
            ['field' => 'han_dung', 'title' => 'H·∫°n d√πng'],
            ['field' => 'co_so_san_xuat', 'title' => 'C∆° s·ªü s·∫£n xu·∫•t', 'align' => 'left'],
            ['field' => 'don_gia', 'title' => 'ƒê∆°n gi√°', 'type' => 'numeric'],
            ['field' => 'gia_ke_khai', 'title' => 'Gi√° k√™ khai', 'type' => 'numeric'],
        ];
    
        $defaults = [
            'templatePath' => database_path('exports/MAU-BANG-BAO-GIA.xlsx'),
            'sheetName'    => 'Sheet1',
            'startRow'     => 10,
            'columns'      => $defaultColumns,
            'auto_width'   => false,
            'auto_height'  => true,
            'fit_to_page'  => true,
            'row_font'     => ['name' => 'Times New Roman', 'size' => 12],
            'titles'       => [
                ['cell' => 'A1', 'text' => 'B·∫¢NG B√ÅO GI√Å', 'style' => ['bold' => true, 'size' => 16, 'align' => 'center'], 'merge' => 'A1:F1'],
                ['cell' => 'L12', 'text' => 'TP.HCM, ng√†y ' . now()->day . ' th√°ng ' . now()->month . ' nƒÉm ' . now()->year, 'style' => ['align' => 'right']]
            ],
        ];
    
        // Merge options ng∆∞·ªùi d√πng truy·ªÅn v√†o
        $options = array_merge($defaults, $options);
    
        // ----- 2Ô∏è‚É£ L·∫•y d·ªØ li·ªáu t·ª´ DB -----
        $fields = array_column($options['columns'], 'field');
        $data = \App\Models\Medicine::whereIn('id', $this->selectedProducts)
            ->get($fields);
    
        $options['data'] = $data;
    
        // ----- 3Ô∏è‚É£ G·ªçi exportTemplate -----
        return $this->exportTemplate($options);
    }
    

}
